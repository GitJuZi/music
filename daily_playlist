console.log("ðŸŽµ æ’­æ”¾è„šæœ¬å¯åŠ¨ï¼ˆå†™æ­» Cookie + UA æµ‹è¯•ï¼‰");

// è¯·æŠŠè¿™é‡Œæ›¿æ¢æˆä½ çš„å®Œæ•´ Cookie å­—ç¬¦ä¸²ï¼ˆå¤åˆ¶ä½ çš„ Netease_Musician_Cookie å†…å®¹ï¼‰
const cookie = "ntes_kaola_ad=1; EVNSM=1.0.0; NMCID=vulbjn.1749353184000.01.3; NMDI=Q1NKTQcBDAAG8RKQZ6kS6r8cJhNoAAAACJkYL5j%2BHkaoDGN9ILilGAPVyadEidon5urHIaoJBHXdDDEVbnWlza6u9bI7V3%2FjqCrkDdpk3ttKaTD%2FdlTvwELbGG8ifk82pangiWpnkVEEV4PFuwL%2F1zK25o72xYxVKCmF%2Fygmx0A%3D; URS_APPID=E23351ECCFC05FAA634A9989B5D033B6B6D734D9C3D32567390D498F9BECA24C9CC2821647BBF7FC67D9350F9678A060; appkey=IuRPVVmc3WWul9fT; appver=9.3.15; buildver=6032; caid={"lastIyunId":"dcf14365a19b6d7872838e92f776662e","iyunId":"fd8d5279ad99808c35e7eaf3419b1e3a","iyunVersion":"20230330","lastIyunVersion":"20220111"}; channel=distribution; deviceId=dcd9c8e67d6fc0f893a0e73acbae3daf; idfa=; idfv=27C28449-8390-4A77-ABA9-5FEAB4E1367A; machineid=iPhone13.4; os=iPhone OS; osver=16.6.1; packageType=release; sDeviceId=434d43a89fe726f2ccb3fdecf671bfae; WEVNSM=1.0.0; JSESSIONID-WYYY=dWD04SfgOSaDV3hrQn6ZA8jQg8gtFTrijWzkRZWdMZSq5qt3EiqRuvMcHm3HwP5EEDW4z%2F1gArtKnG9Cm%2FJsTeWsI%2BRbuKDDjGeZws60PrDmh%2FaWlpVPS4OdNtJMNoq8iPa%5CSeH96geZMfxjfZJ7xZj%2BqE%2B4TM6giMuwG6Vv2Bm2PCCf%3A1750666168894; _iuqxldmzr_=33; MUSIC_U=001E1FD1565A561977D9F5ED5D14C6D5B485A64E3ED153DED0D757D5FA8D506AAA6CC51A690C3BB3BB0CD7839B683DD8C65E1E876EBFAF22E00B4E3CE403B8A9C5BE3B9CEE4807C66D37C1B6F571341D8786F3DAA25E711918D69560FA8540AA331CF8187017AC3E783E9880E1D835526E7E923EB6F6B1729E7EDD110DA634015009D9B9E483F1BAA3744CA7AD58198C89D22AD419AC5DAB079FDE42D80B6F8C06878134E53F4CF090672B957BED2FCF078EDE07109BAE8BE933C944F5148C33021BC50A9F6D668CDF1C4C71AEEC29BB9A6C80A1D962A162FE07E52DE34342605FB55833CC318F821F82852C205F7C0897D24AA0741351351B79204CBEFE27C8F7F07AE8DBDEB92E1529327863791FEA4FA2439770AB1968704269BADB984FEF3F; __csrf=dfbbd7e744de4d561d9d38471dedbc4b; __csrf=987e69cfb2344c6e4ec4546458c41d58; WNMCID=xxnsrp.1749368426791.01.0; _ntes_nnid=41dc13576fedc706c27d9c46df5245df,1749353167073; _ntes_nuid=41dc13576fedc706c27d9c46df5245df; NMTID=00Ow6Nm6hwUobvXck8fgXSULBj2Zq8AAAGXTZL18w";
";

// è¯·æŠŠè¿™é‡Œæ›¿æ¢æˆä½ çš„ User-Agent å­—ç¬¦ä¸²ï¼ˆå¤åˆ¶ä½ çš„ Netease_Musician_UserAgent å†…å®¹ï¼‰
const userAgent = "NeteaseMusic 9.3.15/6032 (iPhone; iOS 16.6.1; zh_CN)";

console.log("è¯»å– Cookie:", cookie ? "âœ…" : "âŒ ç©º");
console.log("è¯»å– UA:", userAgent ? "âœ…" : "âŒ ç©º");

if (!cookie || !userAgent) {
  $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ ç¼ºå°‘ Cookie æˆ– User-Agent", "è¯·è¡¥å…¨å†™æ­»å‚æ•°");
  $done();
  return;
}

const playlistId = "3778678";  // ç½‘æ˜“äº‘æ—¥æ¦œæ­Œå•ID
const apiUrl = `https://interface3.music.163.com/eapi/v6/playlist/detail`;

const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
  "Referer": "https://music.163.com",
  "X-Real-IP": "118.88.88.88"
};

// eapiæŽ¥å£è¯·æ±‚ä½“å‚æ•°ï¼ŒurlencodeåŽçš„å­—ç¬¦ä¸²
const body = `params=%7B%22id%22%3A${playlistId}%2C%22n%22%3A1000%2C%22s%22%3A8%7D`;

$httpClient.post(
  {
    url: apiUrl,
    headers: headers,
    body: body
  },
  (error, response, data) => {
    if (error) {
      console.log("âŒ è¯·æ±‚å¤±è´¥ï¼š" + error);
      $done();
      return;
    }
    try {
      const res = JSON.parse(data);
      if (!res.playlist || !res.playlist.trackIds) {
        console.log("âŒ è¿”å›žæ•°æ®ç¼ºå°‘ playlist.trackIds");
        console.log("è¿”å›žå†…å®¹ï¼š" + data);
        $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ æ­Œå•æ•°æ®é”™è¯¯", "è¯·ç¡®è®¤Cookieæœ‰æ•ˆ");
        $done();
        return;
      }
      const trackIds = res.playlist.trackIds.slice(0, 30);
      console.log(`ðŸ“€ æˆåŠŸèŽ·å– ${trackIds.length} é¦–æ­Œæ›²ï¼Œå¼€å§‹æ¨¡æ‹Ÿæ’­æ”¾...`);
      playTracks(trackIds, 0);
    } catch (e) {
      console.log("âŒ JSONè§£æžå¤±è´¥ï¼š" + e);
      console.log("è¿”å›žå†…å®¹ï¼š" + data);
      $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ è§£æžé”™è¯¯", "è¯·ç¡®è®¤Cookieæœ‰æ•ˆ");
      $done();
    }
  }
);

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ");
    $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âœ… æ’­æ”¾å®Œæˆ", `å…±æ’­æ”¾${trackIds.length}é¦–æ­Œæ›²`);
    $done();
    return;
  }
  const id = trackIds[index].id;
  console.log(`â–¶ï¸ æ­£åœ¨æ’­æ”¾ç¬¬ ${index + 1} é¦–ï¼Œæ­Œæ›²IDï¼š${id}`);

  setTimeout(() => {
    playTracks(trackIds, index + 1);
  }, 3000);
}
