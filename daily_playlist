/**
 * 网易云音乐 热门日榜模拟播放脚本（eapi 接口）
 * by @GitJuZi
 */

const cookie = $persistentStore.read("Netease_Musician_Cookie");
const userAgent = $persistentStore.read("Netease_Musician_UserAgent");

console.log("🎵 [播放脚本启动]");
console.log("Cookie:", cookie ? "✅" : "❌");
console.log("User-Agent:", userAgent ? "✅" : "❌");

if (!cookie || !userAgent) {
  $notification.post("网易云播放脚本", "❌ 缺少 Cookie 或 User-Agent", "请先抓取后再运行");
  $done();
}

// 日榜歌单 ID：3778678
const playlistId = "3778678";

// eapi 请求接口
const apiUrl = "https://interface3.music.163.com/eapi/v6/playlist/detail";
const realUrl = `${apiUrl}?id=${playlistId}&n=1000`;
const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
  "Referer": "https://music.163.com",
  "X-Real-IP": "118.88.88.88"
};

const request = {
  url: realUrl,
  method: "POST",
  headers: headers,
  body: `params=%7B%22id%22%3A${playlistId}%2C%22n%22%3A1000%2C%22s%22%3A8%7D`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("❌ 请求失败：" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const trackIds = res.playlist.trackIds.slice(0, 30);

    console.log(`📀 获取成功，共 ${trackIds.length} 首歌`);
    playTracks(trackIds, 0);
  } catch (e) {
    console.log("❌ JSON 解析失败：" + e);
    console.log("返回内容：", data);
    $notification.post("网易云播放脚本", "❌ 歌单数据解析失败", "可能是 Cookie 无效或接口变更");
    $done();
  }
});

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("✅ 所有歌曲播放完毕");
    $notification.post("网易云播放", "✅ 播放完成", `共 ${trackIds.length} 首歌`);
    $done();
    return;
  }

  const id = trackIds[index].id;
  console.log(`▶️ 播放第 ${index + 1} 首歌曲，ID: ${id}`);

  setTimeout(() => {
    playTracks(trackIds, index + 1);
  }, 3000); // 每首歌模拟播放 3 秒
}
