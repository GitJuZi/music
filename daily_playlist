/**
 * ç½‘æ˜“äº‘éŸ³ä¹ çƒ­é—¨æ—¥æ¦œæ¨¡æ‹Ÿæ’­æ”¾è„šæœ¬ï¼ˆeapi æ¥å£ï¼‰
 * by @GitJuZi
 */

const cookie = $persistentStore.read("Netease_Musician_Cookie");
const userAgent = $persistentStore.read("Netease_Musician_UserAgent");

console.log("ğŸµ [æ’­æ”¾è„šæœ¬å¯åŠ¨]");
console.log("Cookie:", cookie ? "âœ…" : "âŒ");
console.log("User-Agent:", userAgent ? "âœ…" : "âŒ");

if (!cookie || !userAgent) {
  $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ ç¼ºå°‘ Cookie æˆ– User-Agent", "è¯·å…ˆæŠ“å–åå†è¿è¡Œ");
  $done();
}

// æ—¥æ¦œæ­Œå• IDï¼š3778678
const playlistId = "3778678";

// eapi è¯·æ±‚æ¥å£
const apiUrl = "https://interface3.music.163.com/eapi/v6/playlist/detail";
const realUrl = `${apiUrl}?id=${playlistId}&n=1000`;
const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
  "Referer": "https://music.163.com",
  "X-Real-IP": "118.88.88.88"
};

const request = {
  url: realUrl,
  method: "POST",
  headers: headers,
  body: `params=%7B%22id%22%3A${playlistId}%2C%22n%22%3A1000%2C%22s%22%3A8%7D`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("âŒ è¯·æ±‚å¤±è´¥ï¼š" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const trackIds = res.playlist.trackIds.slice(0, 30);

    console.log(`ğŸ“€ è·å–æˆåŠŸï¼Œå…± ${trackIds.length} é¦–æ­Œ`);
    playTracks(trackIds, 0);
  } catch (e) {
    console.log("âŒ JSON è§£æå¤±è´¥ï¼š" + e);
    console.log("è¿”å›å†…å®¹ï¼š", data);
    $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ æ­Œå•æ•°æ®è§£æå¤±è´¥", "å¯èƒ½æ˜¯ Cookie æ— æ•ˆæˆ–æ¥å£å˜æ›´");
    $done();
  }
});

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ‰€æœ‰æ­Œæ›²æ’­æ”¾å®Œæ¯•");
    $notification.post("ç½‘æ˜“äº‘æ’­æ”¾", "âœ… æ’­æ”¾å®Œæˆ", `å…± ${trackIds.length} é¦–æ­Œ`);
    $done();
    return;
  }

  const id = trackIds[index].id;
  console.log(`â–¶ï¸ æ’­æ”¾ç¬¬ ${index + 1} é¦–æ­Œæ›²ï¼ŒID: ${id}`);

  setTimeout(() => {
    playTracks(trackIds, index + 1);
  }, 3000); // æ¯é¦–æ­Œæ¨¡æ‹Ÿæ’­æ”¾ 3 ç§’
}
