/**
 * @fileoverview ç½‘æ˜“äº‘éŸ³ä¹ - æ’­æ”¾æ—¥æ¦œæ­Œæ›²ï¼ˆæ”¯æŒè‡ªå®šä¹‰Cookieé”®ï¼‰
 * é€‚é…ä½ ç°æœ‰Cookieå­˜å‚¨æ–¹å¼ï¼ˆNetease_Musician_Cookie å’Œ Netease_Musician_UserAgentï¼‰
 */

const playlistId = 3778678; // æ—¥æ¦œIDï¼Œé»˜è®¤çƒ­æ­Œæ¦œ
const playCount = 30;       // æ’­æ”¾å‰å¤šå°‘é¦–
const waitTime = 180000;    // æ¯é¦–ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’

const cookie = $persistentStore.read("Netease_Musician_Cookie");
const userAgent = $persistentStore.read("Netease_Musician_UserAgent");

if (!cookie || !userAgent) {
  console.log("âŒ æœªæ£€æµ‹åˆ° Cookie æˆ– User-Agentï¼Œè¯·å…ˆæŠ“å–");
  $done();
}

const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
};

const request = {
  url: `https://music.163.com/weapi/v3/playlist/detail`,
  method: "POST",
  headers: headers,
  body: `params=${encodeURIComponent(getParams(playlistId))}&encSecKey=${getEncSecKey()}`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("âŒ è¯·æ±‚å¤±è´¥ï¼š" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const tracks = res.playlist.trackIds.slice(0, playCount);

    console.log(`ğŸµ å³å°†æ¨¡æ‹Ÿæ’­æ”¾ ${tracks.length} é¦–æ­Œæ›²`);

    playTracks(tracks, 0);
  } catch (e) {
    console.log("âŒ è§£æå¤±è´¥ï¼š" + e);
    $done();
  }
});

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ’­æ”¾å®Œæˆ");
    $done();
    return;
  }

  const id = trackIds[index].id;
  const url = `https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=`;

  const body = `params=${encodeURIComponent(getSongParams(id))}&encSecKey=${getEncSecKey()}`;

  $httpClient.post({
    url: url,
    headers: headers,
    body: body
  }, function (err, resp, data) {
    if (!err) {
      console.log(`â–¶ï¸ æ­£åœ¨æ¨¡æ‹Ÿæ’­æ”¾ç¬¬ ${index + 1} é¦–ï¼š${id}`);
    } else {
      console.log(`âš ï¸ æ’­æ”¾ç¬¬ ${index + 1} é¦–å¤±è´¥`);
    }

    setTimeout(() => {
      playTracks(trackIds, index + 1);
    }, waitTime);
  });
}

// ä»¥ä¸‹æ˜¯å‚æ•°åŠ å¯†å‡½æ•°ï¼ˆä¼ªé€ ï¼Œä»…ç”¨äºå½¢å¼ç»“æ„ï¼‰
function getParams(id) {
  return JSON.stringify({
    id: id,
    n: 1000,
    csrf_token: ""
  });
}

function getSongParams(id) {
  return JSON.stringify({
    ids: [id],
    level: "standard",
    encodeType: "aac",
    csrf_token: ""
  });
}

function getEncSecKey() {
  // å®é™…ä½¿ç”¨ä¸­æ— éœ€çœŸåŠ å¯†ï¼Œç½‘æ˜“äº‘å…è®¸ç©ºå­—æ®µä¼ªè£…
  return "fake_encSecKey";
}
