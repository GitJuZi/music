console.log("ðŸŽµ æ’­æ”¾è„šæœ¬å¯åŠ¨ï¼ˆLoonä¸“ç”¨ï¼‰");

const cookie = $persistentStore.read("Netease_Musician_Cookie") || "";
const userAgent = $persistentStore.read("Netease_Musician_UserAgent") || "";

console.log("è¯»å– Cookie:", cookie ? "âœ…" : "âŒ ç©º");
console.log("è¯»å– UA:", userAgent ? "âœ…" : "âŒ ç©º");

if (!cookie || !userAgent) {
  $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ ç¼ºå°‘ Cookie æˆ– User-Agent", "è¯·å…ˆè¿è¡ŒæŠ“å–è„šæœ¬");
  $done();
  return;
}

// æ—¥æ¦œæ­Œå•ID
const playlistId = "3778678";

// ç½‘æ˜“äº‘ eapi è¯¦æƒ…æŽ¥å£
const apiUrl = `https://interface3.music.163.com/eapi/v6/playlist/detail`;

const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
  "Referer": "https://music.163.com",
  "X-Real-IP": "118.88.88.88"
};

const body = `params=%7B%22id%22%3A${playlistId}%2C%22n%22%3A1000%2C%22s%22%3A8%7D`;

$httpClient.post(
  {
    url: apiUrl,
    headers: headers,
    body: body
  },
  (error, response, data) => {
    if (error) {
      console.log("âŒ è¯·æ±‚å¤±è´¥ï¼š" + error);
      $done();
      return;
    }
    try {
      const res = JSON.parse(data);
      if (!res.playlist || !res.playlist.trackIds) {
        console.log("âŒ è¿”å›žæ•°æ®ç¼ºå°‘ playlist.trackIds");
        console.log("è¿”å›žå†…å®¹ï¼š" + data);
        $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ æ­Œå•æ•°æ®é”™è¯¯", "è¯·ç¡®è®¤Cookieæœ‰æ•ˆ");
        $done();
        return;
      }
      const trackIds = res.playlist.trackIds.slice(0, 30);
      console.log(`ðŸ“€ æˆåŠŸèŽ·å– ${trackIds.length} é¦–æ­Œæ›²ï¼Œå¼€å§‹æ¨¡æ‹Ÿæ’­æ”¾...`);
      playTracks(trackIds, 0);
    } catch (e) {
      console.log("âŒ JSONè§£æžå¤±è´¥ï¼š" + e);
      console.log("è¿”å›žå†…å®¹ï¼š" + data);
      $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âŒ è§£æžé”™è¯¯", "è¯·ç¡®è®¤Cookieæœ‰æ•ˆ");
      $done();
    }
  }
);

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ");
    $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âœ… æ’­æ”¾å®Œæˆ", `å…±æ’­æ”¾${trackIds.length}é¦–æ­Œæ›²`);
    $done();
    return;
  }
  const id = trackIds[index].id;
  console.log(`â–¶ï¸ æ­£åœ¨æ’­æ”¾ç¬¬ ${index + 1} é¦–ï¼Œæ­Œæ›²IDï¼š${id}`);

  // æ¨¡æ‹Ÿæ’­æ”¾3ç§’
  setTimeout(() => {
    playTracks(trackIds, index + 1);
  }, 3000);
}
