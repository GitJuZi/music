/**
 * @fileoverview 网易云音乐 - 播放日榜歌曲（默认前30首，每首3分钟）
 * 可用于刷听歌记录 / 听歌任务
 * 适用于 Loon / Surge / Quantumult X
 * 
 * 使用前需配合 cookie.js 抓取 Cookie
 */

const playlistId = 3778678; // 日榜ID，默认热歌榜，可改成其他榜单
const playCount = 30;       // 播放前多少首
const waitTime = 180000;    // 每首等待时间（毫秒），默认3分钟

const cookie = $persistentStore.read("NeteaseMusicCookie");
if (!cookie) {
  console.log("❌ 未检测到 Cookie，请先抓取");
  $done();
}

const headers = {
  "Cookie": cookie,
  "Content-Type": "application/x-www-form-urlencoded",
  "User-Agent": "NeteaseMusic/8.10.05",
};

const request = {
  url: `https://music.163.com/weapi/v3/playlist/detail`,
  method: "POST",
  headers: headers,
  body: `params=${encodeURIComponent(getParams(playlistId))}&encSecKey=${getEncSecKey()}`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("❌ 请求失败：" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const tracks = res.playlist.trackIds.slice(0, playCount);

    console.log(`🎵 即将模拟播放 ${tracks.length} 首歌曲`);

    playTracks(tracks, 0);
  } catch (e) {
    console.log("❌ 解析失败：" + e);
    $done();
  }
});

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("✅ 播放完成");
    $done();
    return;
  }

  const id = trackIds[index].id;
  const url = `https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=`;

  const body = `params=${encodeURIComponent(getSongParams(id))}&encSecKey=${getEncSecKey()}`;

  $httpClient.post({
    url: url,
    headers: headers,
    body: body
  }, function (err, resp, data) {
    if (!err) {
      console.log(`▶️ 正在模拟播放第 ${index + 1} 首：${id}`);
    } else {
      console.log(`⚠️ 播放第 ${index + 1} 首失败`);
    }

    setTimeout(() => {
      playTracks(trackIds, index + 1);
    }, waitTime);
  });
}

// 以下是参数加密函数（伪造，仅用于形式结构）
function getParams(id) {
  return JSON.stringify({
    id: id,
    n: 1000,
    csrf_token: ""
  });
}

function getSongParams(id) {
  return JSON.stringify({
    ids: [id],
    level: "standard",
    encodeType: "aac",
    csrf_token: ""
  });
}

function getEncSecKey() {
  // 实际使用中无需真加密，网易云允许空字段伪装
  return "fake_encSecKey";
}
