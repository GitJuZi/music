/**
 * ç½‘æ˜“äº‘éŸ³ä¹ æ—¥æ¦œæ’­æ”¾è„šæœ¬ï¼ˆLoon ç‰ˆï¼‰
 * Cookie é”®åï¼šNetease_Musician_Cookie
 * UserAgent é”®åï¼šNetease_Musician_UserAgent
 * by @GitJuZi
 */

const cookie = $persistentStore.read("Netease_Musician_Cookie");
const userAgent = $persistentStore.read("Netease_Musician_UserAgent");

console.log("ğŸµ [æ’­æ”¾è„šæœ¬å¯åŠ¨]");
console.log("è¯»å–åˆ°çš„ Cookie:", cookie ? "âœ… æœ‰" : "âŒ æ— ");
console.log("è¯»å–åˆ°çš„ UA:", userAgent ? "âœ… æœ‰" : "âŒ æ— ");

if (!cookie || !userAgent) {
  $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âš ï¸ ç¼ºå°‘ Cookie æˆ– UA", "è¯·å…ˆæŠ“å–åå†è¿è¡Œ");
  $done();
}

const headers = {
  "Cookie": cookie,
  "User-Agent": userAgent,
  "Content-Type": "application/x-www-form-urlencoded",
};

// è·å–çƒ­æ­Œæ¦œæ’­æ”¾åˆ—è¡¨
const playlistId = 3778678; // çƒ­æ­Œæ—¥æ¦œ ID
const request = {
  url: `https://music.163.com/weapi/v3/playlist/detail`,
  method: "POST",
  headers: headers,
  body: `params=${encodeURIComponent(getParams(playlistId))}&encSecKey=${getEncSecKey()}`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("âŒ è¯·æ±‚æ’­æ”¾åˆ—è¡¨å¤±è´¥ï¼š" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const trackIds = res.playlist.trackIds.slice(0, 30);

    console.log(`ğŸ“€ å…±è·å–åˆ° ${trackIds.length} é¦–æ­Œï¼Œå°†æ¨¡æ‹Ÿæ’­æ”¾...`);
    playTracks(trackIds, 0);
  } catch (e) {
    console.log("âŒ æ’­æ”¾åˆ—è¡¨è§£æå¤±è´¥ï¼š" + e);
    $done();
  }
});

// æ¨¡æ‹Ÿæ’­æ”¾
function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ‰€æœ‰æ­Œæ›²æ’­æ”¾å®Œæ¯•");
    $notification.post("ç½‘æ˜“äº‘æ’­æ”¾è„šæœ¬", "âœ… å·²æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ", `å…± ${trackIds.length} é¦–`);
    $done();
    return;
  }

  const id = trackIds[index].id;
  const playReq = {
    url: `https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=`,
    method: "POST",
    headers: headers,
    body: `params=${encodeURIComponent(getSongParams(id))}&encSecKey=${getEncSecKey()}`
  };

  $httpClient.post(playReq, function (err, resp, data) {
    console.log(`â–¶ï¸ æ’­æ”¾ç¬¬ ${index + 1} é¦–ï¼Œæ­Œæ›² ID: ${id}`);
    setTimeout(() => {
      playTracks(trackIds, index + 1);
    }, 3000); // æ’­æ”¾é—´éš”å¯è°ƒï¼ˆé»˜è®¤æ¯é¦– 3 ç§’ï¼‰
  });
}

// åŠ å¯†å‚æ•°ï¼ˆæ¨¡æ‹Ÿç»“æ„ï¼‰
function getParams(id) {
  return JSON.stringify({
    id: id,
    n: 1000,
    csrf_token: ""
  });
}

function getSongParams(id) {
  return JSON.stringify({
    ids: [id],
    level: "standard",
    encodeType: "aac",
    csrf_token: ""
  });
}

function getEncSecKey() {
  return "fake_encSecKey";
}
