/**
 * @fileoverview ç½‘æ˜“äº‘éŸ³ä¹ - æ’­æ”¾æ—¥æ¦œæ­Œæ›²ï¼ˆé»˜è®¤å‰30é¦–ï¼Œæ¯é¦–3åˆ†é’Ÿï¼‰
 * å¯ç”¨äºåˆ·å¬æ­Œè®°å½• / å¬æ­Œä»»åŠ¡
 * é€‚ç”¨äº Loon / Surge / Quantumult X
 * 
 * ä½¿ç”¨å‰éœ€é…åˆ cookie.js æŠ“å– Cookie
 */

const playlistId = 3778678; // æ—¥æ¦œIDï¼Œé»˜è®¤çƒ­æ­Œæ¦œï¼Œå¯æ”¹æˆå…¶ä»–æ¦œå•
const playCount = 30;       // æ’­æ”¾å‰å¤šå°‘é¦–
const waitTime = 180000;    // æ¯é¦–ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤3åˆ†é’Ÿ

const cookie = $persistentStore.read("NeteaseMusicCookie");
if (!cookie) {
  console.log("âŒ æœªæ£€æµ‹åˆ° Cookieï¼Œè¯·å…ˆæŠ“å–");
  $done();
}

const headers = {
  "Cookie": cookie,
  "Content-Type": "application/x-www-form-urlencoded",
  "User-Agent": "NeteaseMusic/8.10.05",
};

const request = {
  url: `https://music.163.com/weapi/v3/playlist/detail`,
  method: "POST",
  headers: headers,
  body: `params=${encodeURIComponent(getParams(playlistId))}&encSecKey=${getEncSecKey()}`
};

$httpClient.post(request, function (error, response, data) {
  if (error) {
    console.log("âŒ è¯·æ±‚å¤±è´¥ï¼š" + error);
    $done();
    return;
  }

  try {
    const res = JSON.parse(data);
    const tracks = res.playlist.trackIds.slice(0, playCount);

    console.log(`ğŸµ å³å°†æ¨¡æ‹Ÿæ’­æ”¾ ${tracks.length} é¦–æ­Œæ›²`);

    playTracks(tracks, 0);
  } catch (e) {
    console.log("âŒ è§£æå¤±è´¥ï¼š" + e);
    $done();
  }
});

function playTracks(trackIds, index) {
  if (index >= trackIds.length) {
    console.log("âœ… æ’­æ”¾å®Œæˆ");
    $done();
    return;
  }

  const id = trackIds[index].id;
  const url = `https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=`;

  const body = `params=${encodeURIComponent(getSongParams(id))}&encSecKey=${getEncSecKey()}`;

  $httpClient.post({
    url: url,
    headers: headers,
    body: body
  }, function (err, resp, data) {
    if (!err) {
      console.log(`â–¶ï¸ æ­£åœ¨æ¨¡æ‹Ÿæ’­æ”¾ç¬¬ ${index + 1} é¦–ï¼š${id}`);
    } else {
      console.log(`âš ï¸ æ’­æ”¾ç¬¬ ${index + 1} é¦–å¤±è´¥`);
    }

    setTimeout(() => {
      playTracks(trackIds, index + 1);
    }, waitTime);
  });
}

// ä»¥ä¸‹æ˜¯å‚æ•°åŠ å¯†å‡½æ•°ï¼ˆä¼ªé€ ï¼Œä»…ç”¨äºå½¢å¼ç»“æ„ï¼‰
function getParams(id) {
  return JSON.stringify({
    id: id,
    n: 1000,
    csrf_token: ""
  });
}

function getSongParams(id) {
  return JSON.stringify({
    ids: [id],
    level: "standard",
    encodeType: "aac",
    csrf_token: ""
  });
}

function getEncSecKey() {
  // å®é™…ä½¿ç”¨ä¸­æ— éœ€çœŸåŠ å¯†ï¼Œç½‘æ˜“äº‘å…è®¸ç©ºå­—æ®µä¼ªè£…
  return "fake_encSecKey";
}
